# MVP 狼人殺實作檢查報告

## ✅ 已完成的核心功能

### 1. 遊戲引擎核心
- ✅ `initializeGame` - 角色分配邏輯正確（3狼、1預言、1女巫、1獵人、4村民）
- ✅ `checkVictory` - 勝負判斷邏輯正確
- ✅ `getAvailableActions` - 根據階段和角色提供可用操作
- ✅ `applyAction` - 大部分操作邏輯已實作
- ✅ `getPlayerView` - 玩家視角分離（公開/私有資訊）

### 2. Socket.IO 整合
- ✅ 玩家加入房間機制
- ✅ `game:start` 事件處理
- ✅ `game:action` 事件處理
- ✅ 狀態同步廣播

### 3. 前端 UI
- ✅ 暱稱輸入
- ✅ QR Code 顯示
- ✅ 遊戲狀態顯示
- ✅ 操作按鈕（根據可用操作動態顯示）
- ✅ 玩家列表、存活/死亡狀態顯示

### 4. 資料庫
- ✅ Prisma Room 模型
- ✅ 房間 CRUD 操作層

---

## ⚠️ 發現的問題與缺漏

### 🔴 關鍵問題（會影響遊戲流程）

#### 1. **自動推進機制缺失**
**問題**：`day:apply_night_deaths` 和 `day:announce_deaths` 這兩個步驟應該**自動執行**，但目前沒有自動推進邏輯。

**影響**：
- 警長競選結束後，應該自動進入 `day:apply_night_deaths`，但現在需要手動觸發
- 這會導致遊戲卡住

**建議修復**：
在 `socket-server.js` 的 `game:action` 處理中，當某個 action 完成後，檢查是否需要自動推進：
```javascript
// 在 applyAction 後，檢查是否需要自動推進
if (newState.step === "day:apply_night_deaths") {
  // 自動執行系統操作
  const systemAction = {
    type: "day:apply_night_deaths",
    playerId: "system",
    payload: {},
    timestamp: Date.now(),
  };
  const finalState = applyAction(newState, systemAction);
  gameStates.set(roomId, finalState);
}
```

#### 2. **所有玩家準備機制不完整**
**問題**：`ready` action 目前假設「只要有一個玩家點 ready 就進入首夜」，但應該要**所有玩家都準備好**。

**影響**：可能導致部分玩家還沒看角色牌就進入夜晚

**建議修復**：
- 在 `GameState` 中追蹤哪些玩家已準備：`readyPlayers: string[]`
- 只有當 `readyPlayers.length === 10` 時才進入首夜

#### 3. **獵人查看手勢的自動觸發**
**問題**：目前獵人需要手動點擊 `hunter:check_gesture`，但根據規則，這應該在預言家查驗後**自動觸發**。

**影響**：獵人可能忘記查看手勢，導致後續無法開槍

**建議修復**：
在 `seer:check` 完成後，自動為獵人設定手勢，並自動進入警長競選或天亮階段。

#### 4. **狼人協同投票邏輯簡化過度**
**問題**：目前只要有一個狼人投票就進入下一步，但應該要**所有狼人都投票**（或至少多數決）。

**影響**：可能只有一個狼人決定殺誰，其他狼人沒有參與感

**建議修復**：
- 追蹤哪些狼人已投票：`wolfVotes: Record<string, string>`
- 只有當所有存活狼人都投票後，才進入女巫階段

---

### 🟡 次要問題（不影響核心流程，但體驗不佳）

#### 5. **白天發言階段未實作**
**問題**：`day:speeches` 階段目前沒有實際的發言機制，只是直接跳到投票。

**影響**：玩家無法發言討論

**建議**：
- 可以先用「簡單的發言順序提示」+ 一個「發言完畢」按鈕
- 或暫時跳過發言，直接進入投票（MVP 可接受）

#### 6. **警長競選的隨機順序觸發時機**
**問題**：`sheriff:randomize_order` 步驟應該在收集完所有候選人後自動執行，但目前是在 `sheriff:skip` 時才執行。

**影響**：如果最後一個玩家選擇「不參選」，可能不會觸發隨機順序

**建議修復**：
- 在收集候選人階段，當所有玩家都選擇完畢（參選或跳過）時，自動進入隨機順序階段

#### 7. **警長死亡後移交警徽未實作**
**問題**：規則中說「警長死後可自己指定一人繼承警徽」，但目前沒有這個機制。

**影響**：警長死後，警徽就消失了

**建議**：
- 在警長死亡時，如果 `options.sheriff.transferOnDeath === "always"`，進入「移交警徽」步驟
- 讓警長選擇繼承人

---

### 🟢 小問題（可以之後再修）

#### 8. **錯誤處理不夠完善**
- Socket.IO 錯誤訊息可以更友善
- 前端錯誤顯示可以更明顯

#### 9. **UI/UX 優化空間**
- 階段提示可以更明顯
- 操作按鈕可以更大、更清楚
- 可以加入「等待中」的動畫

#### 10. **測試覆蓋**
- 沒有單元測試
- 沒有整合測試

---

## 📋 測試建議

### 基本流程測試（必須通過）

1. **建立房間 → 10 人加入 → 開始遊戲**
   - [ ] 可以建立房間
   - [ ] 10 個玩家可以分別加入
   - [ ] 房主可以開始遊戲
   - [ ] 所有玩家看到自己的角色

2. **首夜流程**
   - [ ] 所有玩家點「準備開始」後進入首夜
   - [ ] 狼人可以選擇擊殺目標
   - [ ] 女巫可以看到被刀的人，可以選擇救/毒/跳過
   - [ ] 預言家可以查驗玩家
   - [ ] 獵人自動看到手勢（good/bad）

3. **警長競選**
   - [ ] 所有玩家可以選擇參選/不參選
   - [ ] 候選人發言順序隨機決定
   - [ ] 所有玩家可以投票選警長
   - [ ] 警長票算 1.5 票

4. **白天流程**
   - [ ] 自動套用夜晚死亡結果
   - [ ] 公布昨晚死亡名單
   - [ ] 獵人夜槍（如適用）
   - [ ] 白天投票處決
   - [ ] 獵人白天槍（如適用）

5. **勝負判斷**
   - [ ] 狼人全死 → 好人勝利
   - [ ] 狼人數量 >= 好人數量 → 狼人勝利

### 邊界情況測試

1. **女巫規則**
   - [ ] 不能自救
   - [ ] 解藥只能用一次
   - [ ] 毒藥只能用一次
   - [ ] 不能同一晚同時用解藥+毒藥

2. **獵人規則**
   - [ ] 被毒不能開槍（手勢 bad）
   - [ ] 被刀可以開槍（手勢 good）
   - [ ] 被投票處決可以開槍（手勢 good）

3. **投票平票**
   - [ ] 平票時無人出局，直接入夜

---

## 🎯 建議的修復優先順序

### 高優先級（必須修復才能測試）
1. ✅ 自動推進機制（`day:apply_night_deaths`）
2. ✅ 所有玩家準備機制
3. ✅ 獵人查看手勢自動觸發

### 中優先級（影響體驗）
4. ⚠️ 狼人協同投票
5. ⚠️ 警長競選隨機順序觸發
6. ⚠️ 警長死亡移交警徽

### 低優先級（可以之後再修）
7. 💡 白天發言機制
8. 💡 UI/UX 優化
9. 💡 錯誤處理完善

---

## 🚀 下一步行動

### 選項 A：先修復關鍵問題，再測試
建議先修復上述「高優先級」問題，然後進行完整測試。

### 選項 B：直接開始測試，邊測邊修
可以先進行基本測試，發現問題後再修復。這樣可以更快發現實際使用中的問題。

**我建議選項 B**，因為：
- 可以更快驗證核心流程是否正確
- 實際測試會發現更多細節問題
- 修復時更有針對性

---

## 📝 測試腳本建議

可以準備一個簡單的測試腳本：
1. 用 10 個瀏覽器 tab 模擬 10 個玩家
2. 或找 10 個朋友實際測試
3. 記錄每個步驟是否正常運作
4. 記錄遇到的 bug 和體驗問題
