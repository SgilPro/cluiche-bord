# Phase 2: 狼人殺遊戲實作

## 目標
實作完整的狼人殺遊戲功能，包括遊戲邏輯、狀態管理、Socket.IO 同步。採用「先實作，後抽象」的策略，先讓遊戲能跑起來，未來再做抽象層重構。

## 策略說明
- **現階段**：直接實作狼人殺，不強求抽象層
- **未來**：實作 1-2 款其他遊戲後，再一起重構成抽象類別
- **最終目標**：支援遊戲創建器，可以透過引擎自製遊戲（類似 BoardGameArena）

## 任務範圍

### 1. 遊戲資料模型設計
- [ ] 設計狼人殺的遊戲狀態結構（TypeScript 型別）
  ```typescript
  interface WerewolfGameState {
    phase: 'setup' | 'night' | 'day' | 'voting' | 'finished';
    players: WerewolfPlayer[];
    roles: Role[];
    currentNight?: number;
    currentDay?: number;
    votes?: Vote[];
    // ... 其他狀態
  }
  ```
- [ ] 決定哪些資料存到 Prisma 的 JSON 欄位（`GameSession` 的 `state` 或類似欄位）
- [ ] 決定哪些資料需要關聯表（例如：玩家、角色分配）

### 2. 遊戲核心邏輯（先實作，不抽象）
- [ ] 建立 `src/lib/games/werewolf/` 目錄
- [ ] 實作遊戲初始化邏輯：
  - 角色分配（狼人、村民、預言家、女巫等）
  - 玩家順序
  - 初始狀態設定
- [ ] 實作遊戲階段管理：
  - 夜晚階段（狼人殺人、預言家查驗、女巫用藥）
  - 白天階段（討論、投票）
  - 遊戲結束判斷（狼人獲勝、村民獲勝）
- [ ] 實作動作驗證與執行：
  - 驗證玩家動作是否合法
  - 執行動作並更新狀態
  - 檢查遊戲是否結束

### 3. Socket.IO 遊戲事件
- [ ] 在 `socket-server.js` 新增狼人殺相關事件：
  - `werewolf:join-game` - 加入遊戲
  - `werewolf:action` - 玩家動作（殺人、查驗、投票等）
  - `werewolf:state-update` - 遊戲狀態更新
  - `werewolf:phase-change` - 階段切換
- [ ] 實作事件處理邏輯，確保狀態同步

### 4. 前端遊戲 UI
- [ ] 更新 `src/app/game/[roomId]/page.tsx`：
  - 根據遊戲類型顯示不同的遊戲介面
  - 狼人殺專用 UI 元件
- [ ] 建立 `src/components/games/werewolf/` 目錄
- [ ] 實作基本 UI 元件：
  - 遊戲狀態顯示（當前階段、剩餘玩家等）
  - 玩家列表（顯示角色或隱藏，根據階段）
  - 動作按鈕（根據玩家角色和階段顯示）
  - 投票介面
  - 遊戲結果顯示

### 5. 遊戲狀態持久化
- [ ] 遊戲狀態儲存到 `GameSession` 的 JSON 欄位
- [ ] 實作狀態載入邏輯（從資料庫讀取）
- [ ] 實作狀態儲存邏輯（更新到資料庫）
- [ ] 考慮何時儲存狀態（每次動作後？定時？）

### 6. 遊戲流程實作（基本板子）
- [ ] 實作標準狼人殺流程：
  - 角色分配（你之後會提供詳細規則）
  - 夜晚流程
  - 白天流程
  - 投票機制
  - 遊戲結束條件
- [ ] 先實作「基本可玩」版本，之後再根據你的規則調整

## 預留擴展點（未來抽象化用）

雖然現在不實作抽象層，但可以在程式碼中預留擴展點：

- [ ] 遊戲邏輯放在獨立目錄（`src/lib/games/werewolf/`），方便未來提取
- [ ] 使用一致的命名規範，方便未來重構
- [ ] 遊戲狀態結構盡量通用化（避免過度特化）
- [ ] Socket.IO 事件命名使用前綴（`werewolf:`），方便未來區分不同遊戲

## 技術考量

### 遊戲狀態同步
- 使用 Socket.IO 廣播狀態更新
- 確保所有玩家看到一致的狀態
- 處理斷線重連的情況

### 安全性
- 伺服器端驗證所有遊戲動作
- 防止玩家看到不該看到的資訊（例如：其他玩家的角色）
- 防止作弊（例如：修改前端狀態）

### 效能
- 遊戲狀態使用 JSON 儲存，讀寫頻率需要考慮
- 可以考慮快取機制（Redis，未來優化）

## 檔案結構（預期）
```
src/
├── lib/
│   ├── games/
│   │   └── werewolf/
│   │       ├── types.ts          # 型別定義
│   │       ├── game-logic.ts     # 遊戲邏輯
│   │       ├── state-manager.ts  # 狀態管理
│   │       └── actions.ts        # 動作處理
├── components/
│   └── games/
│       └── werewolf/
│           ├── WerewolfGame.tsx   # 主遊戲元件
│           ├── PlayerList.tsx
│           ├── ActionPanel.tsx
│           └── VotePanel.tsx
└── app/
    └── game/
        └── [roomId]/
            └── page.tsx          # 根據遊戲類型渲染不同元件
```

## 驗收標準
- [ ] 可以建立狼人殺房間
- [ ] 玩家可以加入遊戲
- [ ] 遊戲可以正常進行（角色分配、夜晚、白天、投票）
- [ ] 遊戲狀態正確同步到所有玩家
- [ ] 遊戲結束條件正確判斷
- [ ] 遊戲狀態可以持久化到資料庫

## 後續規劃
- 完成基本狼人殺後，根據你的規則調整細節
- 實作 1-2 款其他遊戲
- 重構成抽象層，支援遊戲創建器

## 注意事項
- 這個階段先以「功能完整」為目標，UI 可以之後再美化
- 遊戲規則細節會由你提供，先建立框架和基本流程
- 預留未來抽象化的空間，但現在不強求
